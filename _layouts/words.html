---
layout: post
---

<script>

</script>

<hr/>
<div id="quiz" class="d-none"> 
    <span class="fs-2">
        <a href="javascript:void(0)" id="toggle" class="btn">Switch to English â†’ Chinese</a> 
    </span><br/>
    <textarea id="word" placeholder="" rows="1" style="width: 100%;" disabled readonly style="background-color: wheat;"></textarea> <br/>
    <textarea id="answer" placeholder="Type your answer" rows="2" style="width: 100%;"></textarea> <br/>
    <span class="fs-2"> <a href="javascript:void(0)" class="btn" onclick="checkAnswer()">âœ” Check (Ctrl+Shift+,)</a> </span>&nbsp;&nbsp;
    <span class="fs-2"> <a href="javascript:void(0)" id="nextButton" class="btn" onclick="nextWord()">â¡ Next (Ctrl+Shift+.)</a> </span>
    <div id="result"></div> 
    <div id="stats"> <div id="coverage"></div> <div id="accuracy"></div> </div>
    <div id="errors"></div>
    <hr/>
</div>
{% if page.month %}

    {% assign month = site.data.words[page.month] %}
    {% if month %}
        {% assign sorted = month.days | sort: "date" | reverse %}

        {% for day in sorted %}
            <h3>ğŸ“… {{ day.date }} 
                <span class="fs-3"> <a href="javascript:void(0)" onclick="startTest()" title="Test">ğŸ“</a> </span>
            </h3>
            {% for word in day.words %}
                {{ forloop.index }}. <a href="javascript:void(0)" onclick="playVoice('{{ word.en }}');">{{ word.en }} ğŸ”Š {{ word.cn }}</a>&nbsp;â†’&nbsp;<a href="https://dict.youdao.com/result?word={{ word.en }}&lang=en" target="_blank">ğŸ”—</a> <br/>
            {% endfor %}
        {% endfor %}

    {% else %}
        <span>{{ page.month }} data not found. </span>       
    {% endif %}

{% endif %}

<script>
    const wordsData = [];
    {% if page.month %}
        {% assign month = site.data.words[page.month] %}
        {% if month %}
            {% assign sorted = month.days | sort: "date" | reverse %}

            {% for day in sorted %}
                {% for word in day.words %}
                    wordsData.push({ en: "{{ word.en }}", cn: "{{ word.cn }}" });
                {% endfor %}
            {% endfor %}

        {% endif %}
    {% endif %}

    function playVoice(word) {
        const url = "https://dict.youdao.com/dictvoice?audio="+word+"&type=2";
        const audio = new Audio(url);
        audio.play();
    }

    function startTest() {
        if (wordsData.length === 0) {
            alert("No words available for testing.");
            return;
        }
        document.getElementById("quiz").classList.remove("d-none");
        nextWord();
    }

  let current = null;
  let mode = "cn_to_en"; /* or "en_to_cn"  */

  /* Tracking coverage and correction rate*/
  let totalWords = wordsData.length; 
  let seen = new Set(); /* tracks which words have been shown */
  let attempts = -1; /* total questions answered */
  let correctCount = 0; /* correct answers */

  /* Levenshtein distance for fuzzy matching */
  function levenshtein(a, b) {
    const dp = Array(a.length + 1).fill(null).map(() =>
      Array(b.length + 1).fill(null)
    );

    for (let i = 0; i <= a.length; i++) dp[i][0] = i;
    for (let j = 0; j <= b.length; j++) dp[0][j] = j;

    for (let i = 1; i <= a.length; i++) {
      for (let j = 1; j <= b.length; j++) {
        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
        dp[i][j] = Math.min(
          dp[i - 1][j] + 1,
          dp[i][j - 1] + 1,
          dp[i - 1][j - 1] + cost
        );
      }
    }
    return dp[a.length][b.length];
  }

  function isFuzzyMatch(a, b) {
    a = a.trim().toLowerCase();
    b = b.trim().toLowerCase();
    const distance = levenshtein(a, b);
    return distance <= 0; /* allow 0 mistakes */
  }

  function weightedRandomWord() { 
    /* Assign weights */
    const weightedList = wordsData.map(w => { 
      const isSeen = seen.has(w.en); 
        return { 
          word: w, 
          weight: isSeen ? 1 : 10 /* unseen words are 10Ã— more likely */
        }; 
    }); 
    /* Compute total weight */
    const totalWeight = weightedList.reduce((sum, item) => sum + item.weight, 0); 
    /* Pick a random number in [0, totalWeight) */
    let r = Math.random() * totalWeight; 
    /* Find the chosen word */
    for (const item of weightedList) { 
      if (r < item.weight) return item.word; 
      r -= item.weight; 
    } 
  }

  function nextWord() {
    /* current = wordsData[Math.floor(Math.random() * wordsData.length)]; */
    current = weightedRandomWord();
    /* Mark this word as seen */
    seen.add(current.en);

    document.getElementById("word").textContent = mode === "en_to_cn" ? current.en : current.cn;

    document.getElementById("answer").value = "";
    document.getElementById("result").textContent = "";
    document.getElementById("answer").focus();

    updateStats();
  }

  function checkAnswer() {
    const user = document.getElementById("answer").value.trim();
    const correct = mode === "en_to_cn" ? current.cn : current.en;

    attempts++;

    if (isFuzzyMatch(user, correct)) {
        correctCount++;
      document.getElementById("result").textContent = "Correct!";
    } else {
      document.getElementById("result").textContent =
        "Not quite. Correct answer: " + correct;
      document.getElementById("errors").innerHTML += `<div>âŒ ${mode === "en_to_cn" ? current.en : current.cn} â†’ ${correct} (Your answer: ${user})</div>`;
    }

    updateStats();
    /* setTimeout(nextWord, 1000); */
  }

  document.getElementById("toggle").addEventListener("click", () => {
    mode = mode === "en_to_cn" ? "cn_to_en" : "en_to_cn";
    document.getElementById("toggle").textContent =
      mode === "en_to_cn"
        ? "Switch to Chinese â†’ English"
        : "Switch to English â†’ Chinese";
    nextWord();
  });

  function updateStats() { 
    document.getElementById("coverage").textContent = `Coverage: ${seen.size} / ${totalWords}`; 
    /* alert(correctCount + " | seen: " + seen.size); */
    const rate = attempts === 0 ? "Accuracy: --" : `Accuracy: ${Math.round((correctCount / attempts) * 100)}%`; 
    document.getElementById("accuracy").textContent = rate; 
}

    document.addEventListener("keydown", function (e) {
      /* Ctrl + [ */
      if (e.ctrlKey && e.key === "[") { e.preventDefault(); checkAnswer(); } 
      /* Ctrl + ] */
      else if (e.ctrlKey && e.key === "]") { e.preventDefault(); nextWord(); }
    });


</script>